name: Build and upload .deb files

on:
  push:
    branches:
      - "debian-packaging"

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  PACKAGES: can_msgs carma_cmake_common carma_debug_msgs carma_debug_ros2_msgs carma_driver_msgs carma_localization_msgs carma_msgs carma_perception_msgs carma_planning_msgs carma_v2x_msgs cav_msgs cav_srvs j2735_msgs j2735_v2x_msgs

jobs:
  apt-repo:
    runs-on: ubuntu-latest
    container:
      image: usdotfhwastoldev/autoware.ai:develop
      options: --user root
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt -y install debhelper devscripts equivs
          sudo gem install deb-s3
      - name: Build and upload .deb files
        run: |
          git config --global --add safe.directory '*'

          # Temporarily required until bootstrapping from the apt repo is fixed
          cd $GITHUB_WORKSPACE/carma_cmake_common
          debuild -us -uc -j -b
          sudo dpkg -i ../carma-cmake-common*.deb
          cd $GITHUB_WORKSPACE/j2735_msgs
          debuild -us -uc -j -b
          sudo dpkg -i ../carma-j2735-msgs*.deb
          cd $GITHUB_WORKSPACE/cav_msgs
          debuild -us -uc -j -b
          sudo dpkg -i ../carma-cav-msgs*.deb
          cd $GITHUB_WORKSPACE/carma_planning_msgs
          debuild -us -uc -j -b
          sudo dpkg -i ../carma-planning-msgs*.deb || true
          sudo apt -f -y install

          for PACKAGE in $PACKAGES; do
            git clean -dfx
            cd $GITHUB_WORKSPACE/$PACKAGE
            mk-build-deps
            sudo dpkg -i *.deb || true
            sudo apt -f -y install
            debuild -us -uc -j -b
            deb-s3 upload --codename develop --bucket ${{ secrets.AWS_BUCKET_NAME }} ../*.deb
          done
